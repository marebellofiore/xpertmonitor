WITH calc AS (
    SELECT
        d.folio,
        SUM(
            CASE 
                WHEN d.dc = 'D' THEN d.jumlah
                WHEN d.dc = 'C' THEN -d.jumlah
                ELSE 0
            END
        ) AS calc_balance
    FROM dbo.f_dtl d
    WHERE d.flag_dele = ''
    GROUP BY d.folio
)
SELECT
    f.folio,
    f.balance AS folio_balance,
    c.calc_balance,
    c.calc_balance - f.balance AS selisih
FROM calc c
JOIN dbo.folio f
    ON c.folio = f.folio
WHERE
    f.flag = 'I'
    AND c.calc_balance <> f.balance
ORDER BY
    ABS(c.calc_balance - f.balance) DESC;
